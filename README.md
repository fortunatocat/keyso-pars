# keyso-pars

CLI-инструмент для пакетного сбора SEO-метрик доменов через API [Keys.so](https://keys.so).

---

> Заметки по SEO‑автоматизации, парсингу, серой и белой сеошке — в **Telegram‑канале**: https://t.me/seo_dreams

---

## Что делает

Читает входной файл со списком доменов (CSV или TXT), запрашивает метрики по каждому домену через Keys.so API (пакетами до 100 штук) и дописывает результаты в выходной CSV. Умеет возобновлять работу с места остановки.

**Собираемые метрики:**
- `it1`, `it3`, `it5`, `it10`, `it50` — количество ключей в топ-1/3/5/10/50
- `vis` — видимость домена
- `http_status` — статус HTTP-ответа
- `error` — текст ошибки, если запрос не прошёл

## Установка

```bash
# Клонировать репозиторий
git clone <repo-url>
cd keyso-pars

# Создать виртуальное окружение
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# Установить зависимости
pip install -r requirements.txt
```

## Настройка

Создайте файл `.env` в корне проекта:

```env
KEYSSO_TOKEN=ваш_токен_от_keys.so
```

Токен можно получить в личном кабинете Keys.so.

## Использование

Положите входной файл в директорию проекта под именем `domains.txt` или `domains.csv` и запустите:

```bash
python parser_keyso.py
```

Скрипт автоматически найдёт файл. Если нужно указать другой путь — используйте `--input`.

### Параметры CLI

| Параметр | По умолчанию | Описание |
|---|---|---|
| `--input` | *(авто)* | Путь к входному файлу. Если не указан — ищет `domains.txt`, затем `domains.csv` в текущей директории |
| `--output` | `output/donors_keyso.csv` | Путь к выходному CSV-файлу |
| `--base` | `msk` | Регион (база Keywords.so) |
| `--domain-col` | `Домен` | Название колонки с доменами в CSV (игнорируется для `.txt`) |
| `--limit` | `0` (все) | Максимальное кол-во доменов за запуск |
| `--batch-size` | `100` | Доменов в одном пакете (не более 100) |
| `--no-completion-check` | — | Отключить финальную проверку полноты |

### Примеры

```bash
# Обработать домены — файл domains.txt или domains.csv в текущей директории
python parser_keyso.py

# Указать файл явно
python parser_keyso.py --input domains.txt
python parser_keyso.py --input domains.csv

# Сохранить результат в другой файл
python parser_keyso.py --output results/output.csv

# Обработать только первые 500 доменов
python parser_keyso.py --limit 500

# Другая база и колонка с доменами (только для CSV)
python parser_keyso.py --input domains.csv --base spb --domain-col "site"
```

## Форматы входного файла

Входной файл должен называться **`domains.txt`** или **`domains.csv`** и лежать в директории проекта. Формат определяется **по расширению**:
- `.txt` → TXT-режим (список доменов)
- `.csv` → CSV-режим (таблица с колонками)

При использовании `--input` можно указать любой путь и имя — формат всё равно определяется по расширению.

### CSV (несколько колонок)

Файл `domains.csv` должен содержать колонку с доменами (по умолчанию `Домен`). Остальные колонки сохраняются в выходном файле без изменений.

```
ID площадки,Домен,Трафик в сутки,...
1,example.com,1500,...
2,another-site.ru,340,...
```

### TXT (только список доменов)

Файл должен называться с расширением `.txt`, например `domains.txt`, `sites.txt`. Один домен на строку. Пустые строки и строки, начинающиеся с `#`, игнорируются. Протоколы `http://` / `https://` и завершающие слэши обрезаются автоматически.

```
# Это комментарий — строка игнорируется

example.com
another-site.ru

# Протоколы обрезаются автоматически:
https://third-site.com
http://fourth-site.ru
```

В выходном CSV будет только одна входная колонка — `Домен` — плюс метрики Keys.so.

## Как работает

Инструмент использует **pipeline-режим** для максимальной скорости:

1. Каждые 5 секунд отправляет новый пакет доменов на `POST /report/group`
2. Параллельно опрашивает готовые результаты через `GET /report/group/{token}`
3. Результаты дописываются в выходной CSV сразу по мере поступления
4. Уже обработанные домены при повторном запуске пропускаются (возобновление)
5. По окончании — 3 раунда финальной проверки для пропущенных доменов

**Производительность:** ~35 000 доменов за ~30 минут.

**Лимиты API:**
- Максимум 10 запросов за 10 секунд
- Пакеты >200 доменов возвращают HTTP 410 (инструмент ограничивает до 100)
- Ответ сервера готовится 60–90 секунд

## Структура проекта

```
keyso-pars/
├── parser_keyso.py      # Основной скрипт (pipeline-режим)
├── requirements.txt     # Зависимости Python
├── .env                 # Токен API (не коммитить!)
├── .gitignore
├── domains.txt          # Входной файл — список доменов (один на строку)
├── domains.csv          # Входной файл — таблица с колонкой Домен
├── primer.json          # Пример ответа API
├── tz.txt               # Техническое задание
├── output/              # Выходные CSV (игнорируется git)
└── temp/                # Альтернативная реализация (wave-режим)
```

## Зависимости

- Python 3.6+
- [requests](https://pypi.org/project/requests/) >= 2.31.0
- [python-dotenv](https://pypi.org/project/python-dotenv/) >= 1.0.0
